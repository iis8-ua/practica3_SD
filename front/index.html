<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>EVCharging Central Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e1e; color: #f0f0f0; margin: 0; padding: 20px; }
        h1, h2 { color: #4db8ff; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* Tarjetas de CPs */
        .cp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .card { background-color: #2d2d2d; border-radius: 8px; padding: 15px; border-left: 5px solid gray; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin-top: 0; display: flex; justify-content: space-between; }
        .card p { margin: 5px 0; font-size: 0.9em; color: #ccc; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; color: white; }
        
        /* Colores de estado */
        .status-ACTIVADO { border-left-color: #28a745; } .status-ACTIVADO .status-badge { background-color: #28a745; }
        .status-SUMINISTRANDO { border-left-color: #17a2b8; } .status-SUMINISTRANDO .status-badge { background-color: #17a2b8; }
        .status-PARADO { border-left-color: #ffc107; } .status-PARADO .status-badge { background-color: #ffc107; color: black; }
        .status-AVERIADO { border-left-color: #dc3545; } .status-AVERIADO .status-badge { background-color: #dc3545; }
        .status-DESCONECTADO { border-left-color: #6c757d; } .status-DESCONECTADO .status-badge { background-color: #6c757d; }

        /* Paneles laterales */
        .panel { background-color: #252526; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #3e3e42; }
        .log-entry { font-family: monospace; font-size: 0.85em; border-bottom: 1px solid #333; padding: 5px 0; }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #888; margin-right: 10px; }
        .log-error { color: #ff6b6b; }
        .log-info { color: #4db8ff; }
        
        /* Tabla Drivers */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #444; }
        th { color: #888; }
    </style>
</head>
<body>
    <h1>‚ö° EVCharging Central Monitor</h1>
    
    <div class="dashboard">
        <div>
            <h2>Puntos de Carga (CPs)</h2>
            <div id="cp-container" class="cp-grid">
                <div class="card">Cargando datos...</div>
            </div>
        </div>

        <div>
            <div class="panel">
                <h2>Drivers Registrados</h2>
                <table id="drivers-table">
                    <thead><tr><th>ID</th><th>Nombre</th><th>Saldo</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="panel">
                <h2>Log de Eventos (√öltimos 10)</h2>
                <div id="logs-container">Esperando eventos...</div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN: Aseg√∫rate de que este puerto coincide con tu Central (5000 o 9000)
        const API_URL = 'http://localhost:5000/api/estado'; 

        async function actualizarDashboard() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Error conectando con Central");
                const data = await response.json();

                renderCPs(data.cps);
                renderDrivers(data.drivers);
                renderLogs(data.logs);
            } catch (error) {
                console.error(error);
                // No borramos la pantalla, solo logueamos, para evitar parpadeos si falla una petici√≥n puntual
            }
        }

		function renderCPs(cps) {
            const container = document.getElementById('cp-container');
            container.innerHTML = '';
            
            cps.forEach(cp => {
                const estadoClass = `status-${cp.estado}`;
                const regIcon = cp.registrado ? '‚úÖ' : '‚ùå';
                
                const climaTexto = cp.clima === -999 ? "‚òÅÔ∏è --" : `üå°Ô∏è ${cp.clima} ¬∫C`;

                const html = `
                    <div class="card ${estadoClass}">
                        <h3>${cp.id} <span class="status-badge">${cp.estado}</span></h3>
                        <p>üìç ${cp.ubicacion}</p>
                        <p>üí∂ ${cp.precio} ‚Ç¨/kWh</p>
                        <p style="font-weight:bold; color: #ffeb3b;">${climaTexto}</p>
                        
                        <p style="font-size:0.8em; border-top:1px solid #444; padding-top:5px; margin-top:10px;">
                           ${regIcon} <strong>Registro:</strong> ${cp.registrado ? 'S√ç' : 'NO'} <br>
                           üîë <strong>Token:</strong> <span style="font-family:monospace; color:#4db8ff;">${cp.token}</span>
                        </p>
                        <p>üöó ${cp.conductor === 'Libre' ? '<span style="color:#888">Libre</span>' : '<strong>'+cp.conductor+'</strong>'}</p>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderDrivers(drivers) {
            const tbody = document.querySelector('#drivers-table tbody');
            tbody.innerHTML = '';
            drivers.forEach(d => {
                tbody.innerHTML += `<tr><td>${d.id}</td><td>${d.nombre}</td><td>${d.saldo.toFixed(2)}‚Ç¨</td></tr>`;
            });
        }

		function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            
            logs.forEach(log => {
                let colorStyle = 'color: #4db8ff;'; 
                let tipo = log.evento || 'INFO'; 

                if (tipo.includes('AVERIA') || tipo.includes('ERROR') || tipo.includes('SEGURIDAD')) {
                    colorStyle = 'color: #ff6b6b;';
                } else if (tipo.includes('BAJA') || tipo.includes('DESCONECTADO')) {
                    colorStyle = 'color: #ffcc00;';
                } else if (tipo.includes('REGISTRO')) {
                    colorStyle = 'color: #00ff00;'; 
                }

                const fechaObj = new Date(log.fecha);
                const hora = fechaObj.toLocaleTimeString();

                container.innerHTML += `
                    <div class="log-entry" style="border-bottom: 1px solid #333; padding: 4px 0;">
                        <span style="color: #888;">[${hora}]</span>
                        
                        <span style="color: cyan; font-size: 0.9em;">[IP: ${log.ip || '?'}]</span>
                        
                        <strong style="color: white;">${log.origen}</strong>
                        
                        <span style="${colorStyle} font-weight:bold;">[${tipo}]</span>:
                        
                        <span style="color: #ccc;">${log.mensaje}</span>
                    </div>
                `;
            });
        }

        setInterval(actualizarDashboard, 3000);
        actualizarDashboard();
    </script>
</body>
</html>